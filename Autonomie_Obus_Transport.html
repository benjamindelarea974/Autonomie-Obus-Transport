<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Autonomie Gaz – Transport</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --line:rgba(255,255,255,.14);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;

      /* Couleurs plus lumineuses */
      --green:#2bd671;
      --greenBg: rgba(43,214,113,.26);
      --greenBd: rgba(43,214,113,.65);

      --orange:#ff8a3d;
      --orangeBg: rgba(255,138,61,.28);
      --orangeBd: rgba(255,138,61,.70);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(53,122,255,.22), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(43,214,113,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      margin:10px 0 16px 0;
    }
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title p{margin:6px 0 0 0;color:var(--muted);font-size:13px;line-height:1.3}
    .badge{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 880px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{
      margin:0 0 12px 0;
      font-size:16px;
      letter-spacing:.2px
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 540px){ .row{grid-template-columns:1fr} }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 0;
    }
    input, select{
      width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.18);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus{border-color:rgba(255,255,255,.38)}
    input[disabled]{opacity:.6;cursor:not-allowed}

    .hint{
      margin-top:6px;
      font-size:11.5px;
      color:var(--muted);
      line-height:1.25;
    }

    /* === Chips VM : plus petits et sur une seule ligne === */
    .mini{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      margin-top:6px;
      overflow:auto;
      padding-bottom:2px;
    }
    .chip{
      font-size:11px;
      color:rgba(255,255,255,.72);
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      padding:5px 9px;
      background:rgba(255,255,255,.06);
      white-space:nowrap;
      flex:0 0 auto;
    }

    .resultBlock{display:grid;grid-template-columns: 1fr;gap:12px;}

    /* === KPI avec couleurs plus visibles === */
    .kpi{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
    }
    .kpiTop{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;}
    .kpiTop .name{font-size:13px;color:var(--muted)}
    .kpiTop .value{font-weight:800;font-size:16px}

    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{height:100%;width:0%}

    .ok{
      background: var(--greenBg);
      border-color: var(--greenBd);
    }
    .warn{
      background: var(--orangeBg);
      border-color: var(--orangeBd);
    }
    .ok .bar > div{background:var(--green)}
    .warn .bar > div{background:var(--orange)}

    /* === MESSAGE (ex-ALERTE) : très vif === */
.alert{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:16px;
  border-radius:var(--radius);
  border:2px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  box-shadow: 0 12px 32px rgba(0,0,0,.35);
}

.alert .left{display:flex;flex-direction:column;gap:4px}

.alert .label{
  font-weight:950;
  font-size:14px;
  letter-spacing:.9px;
  text-transform:uppercase;
}

.alert .sub{
  font-size:12px;
  color:rgba(255,255,255,.85);
}

.alert .status{
  font-weight:1000;
  font-size:18px;
  letter-spacing:1px;
  padding:8px 14px;
  border-radius:999px;
  border:2px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.18);
  white-space:nowrap;
}

/* Fond + bordure très visibles */
.alert.ok{
  border-color: var(--green);
  background: linear-gradient(135deg, rgba(43,214,113,.48), rgba(43,214,113,.18));
  box-shadow:
    0 0 0 2px rgba(43,214,113,.35) inset,
    0 0 28px rgba(43,214,113,.35),
    0 14px 40px rgba(0,0,0,.35);
}
.alert.warn{
  border-color: var(--orange);
  background: linear-gradient(135deg, rgba(255,138,61,.52), rgba(255,138,61,.18));
  box-shadow:
    0 0 0 2px rgba(255,138,61,.35) inset,
    0 0 28px rgba(255,138,61,.35),
    0 14px 40px rgba(0,0,0,.35);
}

/* GO/STOP reprend la couleur vive */
.alert.ok .status{
  color: #0b1220;
  background: var(--green);
  border-color: rgba(0,0,0,.25);
  box-shadow: 0 0 18px rgba(43,214,113,.55);
}
.alert.warn .status{
  color: #0b1220;
  background: var(--orange);
  border-color: rgba(0,0,0,.25);
  box-shadow: 0 0 18px rgba(255,138,61,.55);
}

    .foot{
      margin-top:14px;
      font-size:11px;
      color:rgba(255,255,255,.55);
      text-align:right;
    }
    .smallNote{
      margin-top:10px;
      font-size:12px;
      color:rgba(255,255,255,.62);
      line-height:1.35
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      background:rgba(255,255,255,.10);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{background:rgba(255,255,255,.13)}

    /* Conso sur 1 ligne, sinon 2 */
    .consosLine{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-weight:700;
    }
    .consosLine span{white-space:nowrap}

/* Étape 3 — textes sous Respirateur / Mode plus petits */
.chip{
  font-size:10px;
  padding:4px 8px;
  opacity:.85;
}

.hint{
  font-size:10.5px;
  line-height:1.2;
  opacity:.85;
}

/* Étape 4 — titres de champs en gras */
label{
  font-weight:800;
  letter-spacing:.2px;
}

/* Étape 5 — MESSAGE très visible */
.alert.ok{
  border:2px solid #2bd671;
  background: linear-gradient(135deg, rgba(43,214,113,.6), rgba(43,214,113,.2));
  box-shadow: 0 0 30px rgba(43,214,113,.5);
}

.alert.warn{
  border:2px solid #ff8a3d;
  background: linear-gradient(135deg, rgba(255,138,61,.65), rgba(255,138,61,.2));
  box-shadow: 0 0 30px rgba(255,138,61,.5);
}

.alert.ok .status{
  background:#2bd671;
  color:#0b1220;
  font-weight:900;
}

.alert.warn .status{
  background:#ff8a3d;
  color:#0b1220;
  font-weight:900;
}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Autonomie Gaz – Transport</h1>
        <p>Calcul rapide d’autonomie O₂ / Air selon respirateur, mode et FiO₂.</p>
      </div>
      <div class="badge">Dr Benjamin Dusang – Réanimation pédiatrique</div>
    </header>

    <div class="grid">
      <!-- INPUTS -->
      <section class="card">
        <h2>Données à renseigner</h2>

        <div class="row">
          <div>
            <label for="resp">Respirateur</label>
            <select id="resp">
              <option>Oxylog 2000</option>
              <option>BabyPAC</option>
              <option>Fabian</option>
            </select>

            <div class="mini">
              <span class="chip" id="chipCpap">VM CPAP : —</span>
              <span class="chip" id="chipVmRetenue">VM retenue : —</span>
            </div>
          </div>

          <div>
            <label for="mode">Mode ventilatoire</label>
            <select id="mode">
              <option>CPAP</option>
              <option selected>Hors CPAP</option>
            </select>
            <div class="hint" id="hintMode">En CPAP, la VM retenue est automatique (selon respirateur).</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="pAir">Pression bouteille Air (bar) — 1 à 250</label>
            <input id="pAir" type="number" inputmode="numeric" min="1" max="250" step="1" placeholder="Ex : 150" />
            <div class="hint">Sans objet pour Oxylog 2000 & Fabian.</div>
          </div>
          <div>
            <label for="pO2">Pression bouteille Oxygène (bar) — 1 à 250</label>
            <input id="pO2" type="number" inputmode="numeric" min="1" max="250" step="1" placeholder="Ex : 110" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="fio2">FiO₂ (%) — 21 à 100</label>
            <input id="fio2" type="number" inputmode="numeric" min="21" max="100" step="1" placeholder="Ex : 40" value="21" />
          </div>
          <div>
            <label for="vmHors">VM hors CPAP (L/min)</label>
            <input id="vmHors" type="number" inputmode="decimal" min="0" step="0.1" placeholder="Ex : 20" />
            <div class="hint">Requis uniquement en mode “Hors CPAP”.</div>
          </div>
        </div>

        <div class="btnRow">
          <button id="btnDemo" type="button">Remplir un exemple</button>
          <button id="btnReset" type="button">Réinitialiser</button>
        </div>

        <div class="smallNote" id="noteValidation"></div>
      </section>

      <!-- RESULTS -->
      <aside class="card">
        <h2>Résultats</h2>

        <div class="resultBlock">
          <div class="alert" id="alertBox">
            <div class="left">
              <div class="label" id="alertLabel">MESSAGE</div>
              <div class="sub" id="alertSub">Renseigne les paramètres pour calculer.</div>
            </div>
            <div class="status" id="alertStatus">—</div>
          </div>

          <div class="kpi" id="kpiAir">
            <div class="kpiTop">
              <div class="name">Autonomie Air (min)</div>
              <div class="value" id="airVal">—</div>
            </div>
            <div class="bar"><div id="airBar"></div></div>
            <div class="hint" id="airHint"></div>
          </div>

          <div class="kpi" id="kpiO2">
            <div class="kpiTop">
              <div class="name">Autonomie Oxygène (min)</div>
              <div class="value" id="o2Val">—</div>
            </div>
            <div class="bar"><div id="o2Bar"></div></div>
            <div class="hint" id="o2Hint"></div>
          </div>

          <div class="kpi">
            <div class="kpiTop">
              <div class="name">Consommations (L/min)</div>
              <div class="value" id="consosVal">
                <div class="consosLine">
                  <span id="consAir">Air : —</span>
                  <span id="consO2">O₂ : —</span>
                </div>
              </div>
            </div>
          </div>

          <div class="foot">Seuil : &lt; 45 min = STOP / ≥ 45 min = GO</div>
        </div>
      </aside>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function clampInt(n, min, max){
    if (Number.isNaN(n)) return null;
    n = Math.round(n);
    if (n < min || n > max) return null;
    return n;
  }
  function toNumber(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function round2(x){ return Math.round(x * 100) / 100; }
  function intTrunc(x){ return Math.trunc(x); }

  function setKpiState(kpiEl, state){
    kpiEl.classList.remove("ok","warn");
    if (state === "ok") kpiEl.classList.add("ok");
    if (state === "warn") kpiEl.classList.add("warn");
  }
  function setBar(barEl, minutes){
    if (!Number.isFinite(minutes)) { barEl.style.width = "0%"; return; }
    const pct = Math.max(0, Math.min(100, (minutes / 120) * 100));
    barEl.style.width = pct.toFixed(0) + "%";
  }

  // VM CPAP "en l'état" (Excel)
  const VM_CPAP = {
    "Oxylog 2000": 10,
    "BabyPAC": 10,
    "Fabian": 20
  };

  function compute(){
    const resp = $("resp").value;
    const mode = $("mode").value;

    const pAir = clampInt(toNumber($("pAir").value), 1, 250);
    const pO2  = clampInt(toNumber($("pO2").value),  1, 250);
    const fio2 = clampInt(toNumber($("fio2").value), 21, 100);
    const vmHors = toNumber($("vmHors").value);

    const vmRetenue = (mode === "CPAP") ? VM_CPAP[resp] : vmHors;

    // Chips
    $("chipCpap").textContent = `VM CPAP : ${VM_CPAP[resp]} L/min`;
    $("chipVmRetenue").textContent = `VM retenue : ${Number.isFinite(vmRetenue) ? vmRetenue + " L/min" : "—"}`;

    // Mode input
    if (mode === "CPAP"){
      $("vmHors").disabled = true;
      $("vmHors").value = "";
      $("hintMode").textContent = "En CPAP, la VM retenue est automatique (selon respirateur).";
    } else {
      $("vmHors").disabled = false;
      $("hintMode").textContent = "En CPAP, la VM retenue est automatique (selon respirateur).";
    }

    // Air input
    if (resp !== "BabyPAC"){
      $("pAir").disabled = true;
      $("pAir").placeholder = "Sans objet";
    } else {
      $("pAir").disabled = false;
      $("pAir").placeholder = "Ex : 150";
    }

    // Validation
    const issues = [];
    if (fio2 === null) issues.push("FiO₂ doit être un entier entre 21 et 100.");
    if (pO2 === null) issues.push("Pression O₂ doit être un entier entre 1 et 250.");
    if (resp === "BabyPAC" && pAir === null) issues.push("Pression Air doit être un entier entre 1 et 250 (BabyPAC).");
    if (mode !== "CPAP" && !(Number.isFinite(vmHors) && vmHors > 0)) issues.push("VM hors CPAP doit être > 0 en mode Hors CPAP.");

    $("noteValidation").textContent = issues.length ? ("⚠️ " + issues.join(" ")) : "";

    if (issues.length){
      renderResults({resp, airApplicable:(resp==="BabyPAC"), consoAir:null, consoO2:null, autAir:null, autO2:null, alert:null, reason:"Données incomplètes."});
      return;
    }

    let consoAir = null;
    let consoO2 = null;
    let autAir = null; // number or "Sans objet"
    let autO2 = null;  // number or "Sans objet"
    const airApplicable = (resp === "BabyPAC");

    if (resp === "Oxylog 2000"){
      consoO2 = round2(((mode === "CPAP" ? 10 : vmRetenue) * (fio2/100)));
      if (!Number.isFinite(consoO2)) consoO2 = 0;
      autO2 = (consoO2 > 0) ? ((pO2 * 5) / consoO2) : null;

      const alert = (Number.isFinite(autO2) && autO2 < 45) ? "STOP" : "GO";
      renderResults({resp, airApplicable:false, consoAir:0, consoO2, autAir:"Sans objet", autO2, alert, reason:null});
      return;
    }

    if (resp === "BabyPAC"){
      const vm = vmRetenue; // CPAP ? 10 : VM
      consoO2 = round2(Math.max(0, Math.min(vm, vm * (((fio2/100) - 0.21) / 0.79))));
      consoAir = round2(Math.max(0, vm - consoO2));

      // Autonomie Air
      if (consoAir <= 0){
        autAir = "Sans objet";
      } else {
        autAir = (intTrunc(pAir * 5) / consoAir);
      }

      // --- Correction FiO2 = 21% ---
      // si consoO2 = 0 : O2 non consommé => autonomie O2 "Sans objet" et ne doit pas déclencher STOP
      if (consoO2 <= 0){
        autO2 = "Sans objet";
      } else {
        autO2 = ((pO2 * 5) / consoO2);
      }

      // Alerte BabyPAC
      // GO si (O2 OK ou Sans objet) ET (Air OK ou Sans objet)
      const airOk = (typeof autAir === "number") ? (autAir >= 45) : true;
      const o2Ok  = (typeof autO2 === "number") ? (autO2 >= 45) : true;

      const alert = (airOk && o2Ok) ? "GO" : "STOP";
      renderResults({resp, airApplicable:true, consoAir, consoO2, autAir, autO2, alert, reason:null});
      return;
    }

    if (resp === "Fabian"){
      const vm = (mode === "CPAP") ? 20 : vmRetenue;
      consoO2 = round2(Math.max(0, vm * (((fio2/100) - 0.21) / 0.79)));
      autO2 = (consoO2 > 0) ? ((pO2 * 5) / consoO2) : null;

      const alert = (Number.isFinite(autO2) && autO2 < 45) ? "STOP" : "GO";
      renderResults({resp, airApplicable:false, consoAir:0, consoO2, autAir:"Sans objet", autO2, alert, reason:null});
      return;
    }
  }

  function renderResults({resp, airApplicable, consoAir, consoO2, autAir, autO2, alert, reason}){
     // Si pas d'alerte = calcul non finalisé (données incomplètes)
  const incomplete = !alert;

  // Air KPI
  if (!airApplicable){
    $("airVal").textContent = "Sans objet";
    $("airHint").textContent = "Sans objet pour ce respirateur.";
    setKpiState($("kpiAir"), null);
    setBar($("airBar"), NaN);
  } else if (incomplete) {
    $("airVal").textContent = "—";
    $("airHint").textContent = "Renseigne les paramètres pour calculer.";
    setKpiState($("kpiAir"), null);
    setBar($("airBar"), NaN);
  } else {
    if (typeof autAir === "number" && Number.isFinite(autAir)){
      $("airVal").textContent = Math.round(autAir) + " min";
      const state = (autAir < 45) ? "warn" : "ok";
      setKpiState($("kpiAir"), state);
      $("airHint").textContent = (autAir < 45) ? "Autonomie Air < 45 min." : "Autonomie Air ≥ 45 min.";
      setBar($("airBar"), autAir);
    } else if (autAir === "Sans objet") {
      $("airVal").textContent = "Sans objet";
      $("airHint").textContent = "Air non limitant (conso Air = 0).";
      setKpiState($("kpiAir"), "ok");
      setBar($("airBar"), 120);
    } else {
      $("airVal").textContent = "—";
      $("airHint").textContent = "Impossible de calculer.";
      setKpiState($("kpiAir"), null);
      setBar($("airBar"), NaN);
    }
  }

  // O2 KPI
  if (incomplete) {
    $("o2Val").textContent = "—";
    $("o2Hint").textContent = "Renseigne les paramètres pour calculer.";
    setKpiState($("kpiO2"), null);
    setBar($("o2Bar"), NaN);
  } else if (autO2 === "Sans objet"){
    $("o2Val").textContent = "Sans objet";
    $("o2Hint").textContent = "O₂ non consommé à cette FiO₂.";
    setKpiState($("kpiO2"), "ok");
    setBar($("o2Bar"), 120);
  } else if (typeof autO2 === "number" && Number.isFinite(autO2)){
    $("o2Val").textContent = Math.round(autO2) + " min";
    const state = (autO2 < 45) ? "warn" : "ok";
    setKpiState($("kpiO2"), state);
    $("o2Hint").textContent = (autO2 < 45) ? "Autonomie O₂ < 45 min." : "Autonomie O₂ ≥ 45 min.";
    setBar($("o2Bar"), autO2);
  } else {
    $("o2Val").textContent = "—";
    $("o2Hint").textContent = "Impossible de calculer.";
    setKpiState($("kpiO2"), null);
    setBar($("o2Bar"), NaN);
  }




    // Consos (1 ligne si possible)
    $("consAir").textContent = airApplicable
      ? `Air : ${Number.isFinite(consoAir) ? consoAir.toFixed(2) : "—"}`
      : "Air : Sans objet";
    $("consO2").textContent = `O₂ : ${Number.isFinite(consoO2) ? consoO2.toFixed(2) : "—"}`;

    // Alert box
    const box = $("alertBox");
    box.classList.remove("ok","warn");
    if (!alert){
      $("alertSub").textContent = reason || "Renseigne les paramètres pour calculer.";
      $("alertStatus").textContent = "—";
      return;
    }
    if (alert === "GO"){
      box.classList.add("ok");
      $("alertStatus").textContent = "GO";
      if (resp === "BabyPAC"){
        $("alertSub").textContent = "Critères OK (O₂ et Air non limitants).";
      } else {
        $("alertSub").textContent = "Critère OK (O₂ ≥ 45 min).";
      }
    } else {
      box.classList.add("warn");
      $("alertStatus").textContent = "STOP";
      if (resp === "BabyPAC"){
        $("alertSub").textContent = "Autonomie O₂ ou Air < 45 min.";
      } else {
        $("alertSub").textContent = "Autonomie O₂ < 45 min.";
      }
    }
  }

  ["resp","mode","pAir","pO2","fio2","vmHors"].forEach(id => {
    $(id).addEventListener("input", compute);
    $(id).addEventListener("change", compute);
  });

  $("btnReset").addEventListener("click", () => {
    $("resp").value = "Oxylog 2000";
    $("mode").value = "Hors CPAP";
    $("pAir").value = "";
    $("pO2").value = "";
    $("fio2").value = "21";
    $("vmHors").value = "";
    compute();
  });

  $("btnDemo").addEventListener("click", () => {
    $("resp").value = "BabyPAC";
    $("mode").value = "Hors CPAP";
    $("pAir").value = "100";
    $("pO2").value = "200";
    $("fio2").value = "21";
    $("vmHors").value = "10";
    compute();
  });

  compute();
</script>
</body>
</html>